\documentclass{article}
\usepackage[utf8]{inputenc}% encodage du fichier source
\usepackage[francais]{babel}% rajouter éventuellement english, greek, etc.
\usepackage{listings}
\usepackage{hyperref}
\usepackage[margin=2.5cm]{geometry}
\hypersetup{urlcolor=,linkcolor=} % Does not apply color to href's
\lstset{
	tabsize=4,
	language=Java,
        basicstyle=\scriptsize,
        columns=fixed,
        extendedchars=true,
        breaklines=true,
		frame=single,
        showtabs=false,
        showspaces=false,
        showstringspaces=false,
        identifierstyle=\ttfamily,
        keywordstyle=\color[rgb]{0,0,1},
        commentstyle=\color[rgb]{0.133,0.545,0.133},
        numbers=left, 
        numberstyle=\tiny,
        xleftmargin=\parindent
}


\title{ANDROID - TP3}
\date{Source, pdf et corrigé de ce TP
:\\\href{http://tiny.cc/techmob}{http://tiny.cc/techmob}}

\begin{document}
\maketitle
L'objectif de ce TP est de réaliser une application utilisant les données
publiques des transports en commun de rennes afin d'afficher le temps
d'attente des bus.\\
Ce TP fera appel aux notions suivantes :
\begin{itemize}
  \item Réseau / requêtes HTTP (webservice)
  \item Parsing JSON
  \item Stockage de données SQLite
  \item Multithreading
  \item ListView
\end{itemize}
Il est fortement conseillé d'avoir le cours à portée de main et à ne pas hésiter
à se référer à la documentation officielle
\href{http://d.android.com}{http://d.android.com} ainsi qu'à la multitude de
tutoriaux disponibles.
\section{Présentation des données star}
\subsection{Contexte}
Rennes a fait partie des premières villes à libérer ses données publiques
concernant les transports en commun. Ainsi, la star met à disposition des
développeurs une grande partie des données concernant son réseau (stations,
horaires, prochains passages \ldots).\\
Les données sont disponibles pour tous, gratuitement.
\subsection{Contenu des données}
Les données disponibles sont réparties en deux catégories : les données
statiques et les données temps réel.
\subsubsection{Les données statiques}
Les données statiques contiennent les informations sur le réseau star : les
stations et leurs emplacements, les lignes et leurs horaires, les équipements
disponibles en station \ldots\\
Ces données n'évoluent que quelques fois par an.\\
La star publie ses données au standard \href{https://developers.google.com/transit/gtfs/reference}{GTFS (General
Transit Feed Specification)}. Concretement, il s'agit simplement de plusieurs
fichiers csv.\\
La documentation sur ces données et la dernière version des données sont
disponibles ici :
\href{http://data.keolis-rennes.com/fr/les-donnees/donnees-telechargeables.html}{http://data.keolis-rennes.com/fr/les-donnees/donnees-telechargeables.html)}

\subsubsection{Les données temps réel}
La star met aussi à disposition des données temps réel. On y trouve le nombre de
vélos et de places disponibles à une station vélo star, les heures de prochain
passage des bus et métro \ldots\\
La liste des données disponibles est disponible ici : 
\href{http://data.keolis-rennes.com/fr/les-donnees/donnees-et-api.html}{http://data.keolis-rennes.com/fr/les-donnees/donnees-et-api.html}\\
L'accès à ces données se fait via un webservice.\\
\textbf{Dans un premier temps, nous ne nous occuperons que des données
statiques.}
\section{Hello World !}
\begin{itemize} 
  \item Créer un nouveau projet (EmptyActivity)
  \item Télécharger les dernières données statiques disponibles sur le site
  open-data de keolis
  \item A l'intérieur du zip téléchargé, ouvrir le fichier routes.txt. Que
  contient t-il ?
  \item Inclure ce fichier dans les ressources de l'application
  \item Créer un objet métier, Route, dont les attributs reflètent le contenu du
  fichier routes
\end{itemize}
On souhaite maintenant écrire le code permettant d'instancier les objets Route à
partir des informations présentes dans le fichier.\\
L'analyse (parsing) d'un fichier CSV est relativement facile mais peut se
réveler fastidieuse. Pour éviter de réécrire à chaque application le même code, on peut utiliser une des multiples bibliothèque disponibles : commons-csv de la
fondation apache.
\begin{itemize}
  \item Télécharger cette bibliothèque à partir du site officiel : X
  \item Ajouter cette bibliothèque à l'application
\end{itemize}
Le code suivant permet d'itérer sur chaque ligne du fichier :\\
\begin{lstlisting}[language=XML]
InputStream stream = context.getResources().openRawResource(R.raw.routes);
Iterator<CSVRecord> iterateur = new CSVParser(new InputStreamReader(stream), CSVFormat.DEFAULT).iterator();
CSVRecord enregistrementCourant = null;
while (iterateur.hasNext()) {
    enregistrementCourant = iterateur.next();
}
stream.close();
\end{lstlisting}
\begin{itemize}
  \item Créer une classe DAO, RouteDAO, qui instancie une liste de Route à
  partir du contenu du fichier
  \item Afficher un toast, sur l'activity principale, indiquant le nombre de
  lignes présentes sur le réseau STAR
\end{itemize}
\section{Un peu d'interface}
\begin{itemize} 
  \item Ajouter une ListView prenant toute la taille de l'écran à l'activity
  principale
  \item Afficher, dans cette ListView, la liste des lignes (au moins le nom)
  \item Optionnel : personnaliser l'affichage en utilisant par exemple le code
  couleur de chaque ligne fourni dans les données
  \item Créer une nouvelle activity qui contiendra le détails des prochains des
  bus de cette ligne
  \item Lors d'un click sur un élément de la liste des lignes, lancer l'activity
  en passant en paramètre l'identifiant de la route choisie
\end{itemize}
\section{Utilisation des données temps réel}
On va maintenant utiliser les données temps réel pour récupérer les horaires des
prochains passages pour la ligne choisie.
\subsection{Principe d'un webservice}
Un webservice est, comme son nom l'indique, un service accessible sur le web.\\
Techniquement, il s'agit d'un programme tournant sur un serveur et déstiné à
diffuser des données brutes (contrairement au HTML, il n'y a pas d'informations
sur la façon d'afficher ces données) via le protocole HTTP.\\
Toutes les requêtes sont testables directement et tapant l'URL dans votre
navigateur préféré.
\subsection{Appel au webservice}
Un webservice est toujours constitué d'une adresse de base suivi d'un paramètre
indiquant le type d'information demandée et éventuellement de paramètres
précisant cette information.\\
Pour le webservice STAR, l'URL de base est la suivante : 
\href{http://data.keolis-rennes.com/json/}{http://data.keolis-rennes.com/json/}\\
Il y a ensuite 3 paramètres obligatoires :
\begin{itemize}
  \item cmd : la commande demandée. C'est à dire, l'information que l'on
  cherche. Par exemple, pour obtenir le prochain départ d'un bus, on a
  $cmd=getbusnextdepartures$
  \item version : la version du webservice que l'on utilise. Se référer à la
  documentation pour savoir quelle version utiliser pour chaque commande. 
  \item key : la clé. Afin de savoir qui utilise le webservice, la STAR fournit
  aux développeurs des clés correspondant à chaque application déclarée. Pour
  obtenir une clé, il faut s'inscrire sur le site. Pour tout ce TP, vous pouvez
  utiliser la clé suivante : 1RJLZ38TUFZSWTW
\end{itemize}
Ainsi, un appel au webservice peut se faire directement à l'URL suivante :\\
\href{http://data.keolis-rennes.com/json/?cmd=getmetrostatus&version=2.2&key=1RJLZ38TUFZSWTW}{http://data.keolis-rennes.com/json/?cmd=getmetrostatus\&version=2.2\&key=1RJLZ38TUFZSWTW}
\subsection{Résultat du webservice}
Le webservice renvoie les données au format JSON ou au format XML (changer
JSON en XML dans l'URL).\\
Pour simplifier, dans ce TP, on ne manipulera que les données JSON.
\subsection{Visualiser le JSON} 
Même si le format JSON est relativement clair et simple, il reste assez
difficile d'obtenir une vision globale des données présentes dans un résultat JSON d'un seul coup d'oeil.\\
Des outils de visualisation JSON existent et sont très utiles dès lors que l'on
manipule des fichiers JSON.\\
Vous pouvez par exemple utiliser
\href{http://jsonviewer.stack.hu/}{http://jsonviewer.stack.hu/}
\subsection{Intégration dans l'application} 
On souhaite afficher, dans la nouvelle Activity, la liste des arrêts de la ligne
choisie.
\begin{itemize} 
  \item Ajouter la permission (uses-permission) INTERNET au manifest
  \item Dans le onCreate de votre Activity, ajouter la ligne suivante 
\begin{lstlisting}[language=XML]
StrictMode.setThreadPolicy(new ThreadPolicy.Builder().permitAll().build());
\end{lstlisting}
Cette ligne sera expliquée plus tard dans le TP
  \item Construire l'adresse qui sera appellée. La commande utilisée est
  ``getbusnextdepartures'' en mode line.
  \item Tester l'adresse dans un navigateur.
  \item Utiliser
  \href{http://developer.android.com/reference/java/net/HttpURLConnection.html}{HttpURLConnection} pour faire une requête HTTP vers le webservice
\end{itemize}
Pour lire le contenu d'un InputStream (flux entrant), on peut s'inspirer du code
suivant :
 \begin{lstlisting}[language=XML]
 public String readStream(InputStream inputStream) throws IOException {
     BufferedReader reader = new BufferedReader(new
     InputStreamReader(inputStream)); 
     String ligne = null;
     String contenu = "";
     while ((ligne = reader.readLine()) != null) {
         contenu += ligne;
     }
     return contenu;
 }
\end{lstlisting}
\begin{itemize} 
  \item Afficher dans la log le contenu de la réponse.
\end{itemize}
\section{Parsing des données}
\subsection{Lire le JSON}
\begin{itemize} 
  \item Créer un objet
  \href{http://developer.android.com/reference/org/json/JSONObject.html}{JSONObject}
  à partir des données récupérées précedemment
  \item En utilisant la méthode
  \href{http://developer.android.com/reference/org/json/JSONObject.html#getJSONArray(java.lang.String)}{getJSONArray},
  récupérer le tableau des arrêts déservis par la ligne
  \item Afficher, dans un Toast, le nombre d'arrêts
\end{itemize}
\subsection{Instancier les objets correspondants}
\begin{itemize} 
  \item Créer une classe Java Arret 
  \item Donner à cette classe les mêmes attributs que les données disponibles dans la réponse JSON
  \item Instancier, à partir du JSONObject, une liste (ou un tableau) d'objet
  Arret
\end{itemize}
\section{Stockage des données}
L'objectif est de stocker les données chargées pour éviter de devoir les
retélécharger à chaque fois (gain de temps, accès hors connexion, économie de
batterie \ldots)
\begin{enumerate}
 \setcounter{enumi}{0}
\item Quelle solution de stockage vous parait la plus adaptée ?
\end{enumerate}
\begin{itemize} 
  \item En utilisant SQLiteOpenHelper, implémenter le nécessaire pour créer une
  base de données SQLite
  \item Dans onCreate, éxecuter une requête de création de table pour créer
  une table Arret avec tous les attributs de la classe Arret
  \item Exécuter une insertion avec des données fictives
  \item Exécuter une ``query'' pour récupérer les données stockées et instancier
  les objets Arret correspondant aux données, les afficher dans la log
  \item Insérer les données récupérées via le webservice
\end{itemize}
\begin{enumerate}
 \setcounter{enumi}{1}
\item Imaginons qu'un jour les données renvoyées par le webservice changent.\\
Comment modifier la base de données SQLite si elle a déjà été crée sur l'appareil ?
\end{enumerate}
\section{Il est temps de faire les choses proprement}
\begin{enumerate}
 \setcounter{enumi}{2}
\item Quel point, vu dans les bonus, a été complétement ignoré depuis le début de ce TP ?
\end{enumerate}
\begin{itemize}
  \item Remplacer la ligne StrictMode ajoutée au début du TP par celle ci
 \begin{lstlisting}[language=XML]
 StrictMode.setThreadPolicy(new ThreadPolicy.Builder().detectNetwork().penaltyDeathOnNetwork().build());
\end{lstlisting} 
  \item Relancer l'application, pleurer
  \item
  \href{http://developer.android.com/reference/android/os/StrictMode.html}{StrictMode}
  est un outil d'aide au développement permettant de détecter les opérations
  longues succeptibles de bloquer un Thread.
  \item Le code ci-dessus indique à StrictMode de faire crasher l'application
  dès qu'un appel réseau est fait dans le Thread actif (ici, le Thread principal
  : main / UI). Depuis le niveau d'API 11, c'est le comportement par défaut.\\La
  ligne ajoutée en début de TP disait à StrictMode de tout laisser passer.
  \item Déplacer le bloc de code correspondant à la requête HTTP dans un Thread
  séparé (utiliser new Thread(Runnable)), sourire.
\end{itemize}
\section{Afficher les données}
\subsection{Afficher la liste des arrêts}
\begin{enumerate}
 \setcounter{enumi}{3}
\item Quel view / viewgroup vous parait le plus adapté pour afficher les cours ?
\end{enumerate}
\begin{itemize} 
  \item Ajouter cet élément au layout en lui faisant prendre toute la place en
  largeur / hauteur
  \item Il nous faut maintenant un adapter : créer une nouvelle classe
  ``ArretAdapter'' qui extends BaseAdapter
  \item Hériter de BaseAdapter implique d'écrire 4 méthodes
  \item Avant d'implémenter ces méthodes, construire un constructeur prenant un
  Context et une liste d'Arret et stocker ces valeurs dans des attributs de
  classe
 \end{itemize}
 \begin{description}
   \item getCount : renvoyer le nombre d'éléments de la liste
   \item getItem : renvoyer le n-ième élément de la liste
   \item getItemId : renvoyer position (il suffit que l'id de chaque item soit
   unique)
   \item getView : ci-dessous un squelette d'une méthode getView. Il faut au
   préalable créer un layout ``layoutarret'' représentant un élement de la
   liste.
 \end{description}
  \begin{lstlisting}[language=XML]
   public View getView(int position, View convertView, ViewGroup parent) {
			View view;
			
			if (convertView == null) {
				view = ((LayoutInflater)
				context.getSystemService(Context.LAYOUT_INFLATER_SERVICE)).inflate(R.layout.layoutarret,
				parent, false); 
			} 
			else { 
				view = convertView;
			}
			Arret arret = (Arret) getItem(position);
	
			TextView idArret = (TextView) view.findViewById(R.id.arret);
			idArret.setText(arret.getIdArret());
			
			return view;
		}
\end{lstlisting} 

 \begin{itemize} 
  \item Instancier un ArretAdapter et l'affecter à la ListView via la méthode
  setAdapter
  \item Il est possible d'affiner le layout de chaque item en rajoutant des
  champs et d'autres informations. Rajouter la date de prochain passage.
\end{itemize}
\section{Pour aller plus loin}
\end{document}


